{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% from 'macros/generate_vuln_table.html' import display_vuln_column %}
{% from 'macros/statusbar.html' import show_progress_statusbar %}

{% set vuln_view = vulnerability_details.vulnerability_view %}
{% if vuln_view %}
  {% block title %}{% set vuln_view = vulnerability_details.vulnerability_view %}{{ vuln_view.id }}{% endblock %}
{% endif %}

{% block main_content %}
  <script>
    const EDITOR_SETTINGS = {{ vulnerability_details.get_settings()|tojson }};
    window.EDITOR_SETTINGS = EDITOR_SETTINGS;
  </script>

  <div class="row">
    <div class="col-md-4 offset-md-4">
      <h2 class="text-center">Review proposal</h2>
    </div>
  </div>

  <div class="row my-3">
    {% set vuln_details=vulnerability_details %}

    <div class="col-sm-4 offset-md-2">
      {% set vulnerability_details=proposal_vulnerability_details %}
      {% set vuln_view = vulnerability_details.vulnerability_view %}
      <h3>Proposal {{ display_vuln_column(vuln_view, 'state') }}</h3>
      {{ show_progress_statusbar(vuln_view) }}

      {% include 'vulnerability/info.html' %}
    </div>

    <div class="col-sm-4">
      {% set vulnerability_details=vuln_details %}
      <h3>Current entry</h3>
      {% include 'vulnerability/info.html' %}
    </div>
  </div>

  {% set vuln_view = proposal_vulnerability_details.vulnerability_view %}
  {% if vuln_view.has_feedback() %}
    <div class="row my-3">
      <div class="col-sm-8 offset-md-2">
        <div class="card my-3">
          <div class="card-body">
            {% include 'review/feedback_card.html' %}
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  <div class="row my-3">
    <div class="col-sm-4 offset-md-2">
      <div class="card">
        <div class="card-body">

          {% if vuln_view.is_reviewable() %}
            The proposal can be assigned to a reviewer.<br />
            <form class="form w-100" method="post" role="form">
              <input type="hidden" name="review_response" value="assign">
              {{ form_assign.hidden_tag() }}
              {{ wtf.form_errors(form_assign, hiddens="only") }}

              <h4>Assign review to you?</h4>
              {{ wtf.form_field(form_assign.submit_assign, button_map={'submit_assign':'primary'}) }}
            </form>
          {% elif vuln_view.is_in_review() %}
            The entry is being reviewed by a moderator.<br />
            {% if vuln_view.is_reviewer() %}
              [<b>TODO:</b> Add option to "unassign" from the review here.]

              <form class="form w-100" method="post" role="form">
                <input type="hidden" name="review_response" value="approve">
                {{ form_approve.hidden_tag() }}
                {{ wtf.form_errors(form_approve, hiddens="only") }}

                <h4>Does this look good to you?</h4>
                {{ wtf.form_field(form_approve.submit_approve, button_map={'submit_approve':'primary'}) }}
              </form>

              <form class="form w-100" method="post" role="form">
                <input type="hidden" name="review_response" value="reject">
                {{ form_reject.hidden_tag() }}
                {{ wtf.form_errors(form_reject, hiddens="only") }}

                <h4>Needs changes before it's ready for approval.</h4>
                {{ wtf.form_field(form_reject.review_feedback) }}
                {{ wtf.form_field(form_reject.submit_reject, button_map={'submit_reject':'danger'}) }}
              </form>
            {% else %}
              This entry is currently already in review by another reviewer.
            {% endif %}
          {% elif vuln_view.is_publishable() %}
            The entry is ready to be published by an admin.<br />
            {% if is_admin() %}
              <form class="form w-100" method="post" role="form">
                <input type="hidden" name="review_response" value="publish">
                {{ form_publish.hidden_tag() }}
                {{ wtf.form_errors(form_publish, hiddens="only") }}
    
                <h4>Does this look good to you?</h4>
                {{ wtf.form_field(form_publish.submit_publish, button_map={'submit_publish':'primary'}) }}
              </form>
          
              <form class="form w-100" method="post" role="form">
                <input type="hidden" name="review_response" value="reject">
                {{ form_reject.hidden_tag() }}
                {{ wtf.form_errors(form_reject, hiddens="only") }}

                <h4>Needs changes before it's ready for approval.</h4>
                {{ wtf.form_field(form_reject.review_feedback) }}
                {{ wtf.form_field(form_reject.submit_reject, button_map={'submit_reject':'danger'}) }}
              </form>
            {% endif %}
          {% elif vuln_view.needs_improvement() %}
            Waiting for author to address given feedback.
          {% elif vuln_view.is_new() %}
            This entry is in a draft/new state. Please submit for review once ready.
          {% else %}
            This entry is ineligible for review.
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {% if vulnerability_details.vulnerability_view %}
    {% block vulnerability_content %}
    {% endblock %}
  {% endif %}

{% endblock %}
